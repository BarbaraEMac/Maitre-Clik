<!DOCTYPE html>
<html lang='en'>
	<head>
		<title>Maitre 'Clik - Mobile</title>
        
        <!-- CSS -->
		<link rel="stylesheet" href="/static/css/reset.css">
		<link rel="stylesheet" href="/static/css/common.css">
		<link rel="stylesheet" href="/static/css/mobile.css">
		<link rel="stylesheet" href="/static/css/jquery-ui-1.8.18.custom.css">

        <!-- JS -->
        <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
        <script src="/static/js/jquery-ui-1.8.18.custom.min.js"></script>
        <script src="http://cdn.jquerytools.org/1.2.7/full/jquery.tools.min.js"></script>
        <script src="http://cdn.clikthis.com/js/latest/clik-mobile.min.js"></script>
    </head>

    <body>
        <!-- Onboard View -->
        <div id="onboardView" style="display: none">
            <div>
                <h1 class="title">Whoa!</h1>

                <p>I don't believe we've met before, have we?</p>

                <button class="limeBtn onboardBtn">Why no! Hello there!</button>
            </div>
            <div style="display: none;">
                <h1 class="title">Welcome!</h1>

                <p>This is Kik's meal tracking app!</p>
                <p>Use this app at every mealtime to guarantee that you'll continue getting the best meals ever!</p>

                <button class="limeBtn onboardBtn">Sounds Great!</button>
            </div>
            <div style="display: none;">
                <h1 class="title">Now ...</h1>

                <p>Let's get to know each other better.</p>

                <label for="onboard_firstName">First Name</label><br />
                <input type="text" id="onboard_firstName" name="onboard_firstName" /><br />

                <label for="onboard_lastName">Last Name</label><br />
                <input type="text" id="onboard_lastName" name="onboard_lastName" /><br />

                <button class="limeBtn onboardBtn">Next</button>
            </div>
            <div style="display: none;">
                <h1 class="title">Email?</h1>

                <p>Psst! I can email you as soon as a meal is delivered!</p>
                <p>You'll never get sloppy seconds now ...</p>

                <label for="onboard_email">Email</label><br />
                <input type="text" id="onboard_email" name="onboard_email" /><br />

                <p class="small">You can change this later.</p>
                <button class="limeBtn onboardBtn">No, thanks.</button>
                <button class="limeBtn onboardBtn">Yes, please!</button>
            </div>
            <div style="display: none;">
                <h1 class="title">All Done!</h1>

                <p>
                    The analytics bots are working hard to generate reports for 
                    your trusty CEO, Tedward, and Wildcraft.
                </p>
                
                <p class="error">Remember to Clik-In at every meal.</p>
                
                <p>Now you're ready to start eating!</p>

                <button class="limeBtn" id="onboardSubmit">To The App!</button>
            </div>
        </div>

        <!-- Vote View -->
        <div id="voteView">
            <h1 class="title" id="voteView_title">Bon Appetit</h1>

            <div id="voteView_wrapper">
                <h1>How awesome is this meal?</h1>
                
                <input type="range" min="1" max="10" step="1" value="5" />

                <p id="voteView_amount">5/10</p>
                
                <div id="voteView_slider" style="max-width: 80%;"> </div>
                
                <button id="voteView_submit"> Submit </button>
                <h1 class="title">Merci!</h1>

                <button id="thanksView_closeBtn">Until your next meal ...</button>
            </div>
        </div>

        <!-- Eating View -->
        <div id="eatingView" style="display: none">
            <h1 class="title">Who's Eating?</h1>
        </div>

        <!-- Profile View -->
        <div id="profileView" style="display: none">
            <h1 class="title">Profile</h1>
        </div>

        <!-- Clik View -->
        <div id="clikView" style="display: none">
            <div id="clikView_out">
                <h1 class="title">Bye</h1>

                <button id="clikView_outBtn">You've been cliked-out!</button>
            </div>
           <div id="clikView_in">
                <h1 class="title">Hello!</h1>
                <p> You must be cliked-in to view that content. </p>
                <button id="clikView_inBtn">Clik-In</button>
            </div>
        </div>

        <div id="btmPanel">
            <button class="lightBlueBtn panelBtn" id="voteViewBtn">    Vote </button>
            <button class="limeBtn panelBtn" id="eatingViewBtn">  Who? </button>
            <button class="limeBtn panelBtn" id="profileViewBtn"> Profile </button>
            <button class="limeBtn panelBtn" id="clikViewBtn">    Clik-Out </button>
        </div>

        <script>
            var MaitreMobile = new function() {
                
                // User obj for current user. 
                this.user = new function () {
                    this.uuid      = "{{user.uuid}}";       // Unique # to id User on Server
                    this.lastName  = "{{user.last_name}}";  // Last Name
                    this.firstName = "{{user.first_name}}"; // First name 
                    this.email     = "{{user.email}}";      // Email address
                    this.img       = "{{user.img}}";        // URL to img of User
                };
                
                // Views for the Mobile App
                this.currentView = $("#voteView");

                this.init = function( ) {
                    // Add name and uuid to Client Obj
                    //Client.prototype.name = "";
                    //Client.prototype.uuid = "";
                    
                    $(":range").rangeinput({ progress: true, max: 100 });

                    $(".onboardBtn").click( function() { $(this).parent().slideUp( 400 ).next().slideDown(); } );
                    $("#onboardSubmit").click( function() { MaitreMobile.createUser(); } );

                    // Don't let people refresh the page if they hit Enter!
                    $("#newUser_wrapper > form").submit(function(){ return false; }); 

                    // Attach key up handlers
                    $("#onboard_firstName").keyup( function() { $("#onboard_email").val( $(this).val() + "@kik.com" ) } );

                    // Attach click handlers.
                    $("#voteView_submit").click( function() { MaitreMobile.vote(); } );

                    $("#voteViewBtn").click(     function() { MaitreMobile.showVoteView(); } );
                    $("#eatingViewBtn").click(   function() { MaitreMobile.showEatingView(); } );
                    $("#profileViewBtn").click(  function() { MaitreMobile.showProfileView(); } );
                    $("#clikViewBtn").click(     function() { MaitreMobile.clikOut(); } );
                    
                    $("#clikView_inBtn").click(  function() { MaitreMobile.clikIn(); } );
                    $("#clikView_outBtn").click( function() { MaitreMobile.clikOut(); } );
                    
                    // Use server logic to determine which view to display.
                    {% if ShowOnboardView %}
                        this.showOnboardView();
                    {% endif %}
                    {% if ShowVoteView %}
                        this.showVoteView();
                    {% endif %}

                    //clik.on('clikIn', function() { MaitreMobile.showVoteView(); } );
                    clik.on('join', function(data) { if( clik.client.id != data ) { alert(data);} } );
                };
                
                this.run = function( ) {
                    /* Call this fcn to start running the App. */
                    this.init(); // Initialize the app.
                };

                this.clikIn = function() {
                    /* Leave the conference */
                    //clik.clikIn();

                    $("#clikViewBtn").html("Clik-Out");
                    $("#clikViewBtn").click( function() { MaitreMobile.clikOut(); } );
                };
                this.clikOut = function() {
                    /* Leave the conference */
                    // clik.clikOut();

                    $("#clikViewBtn").html("Clik-In");
                    $("#clikViewBtn").click( function() { MaitreMobile.clikIn(); } );
                };

                // View Functions ----------------------------------------------
                this.showOnboardView = function( ) {
                    /* Show the "Onboard" View */

                    //if ( clik.connected ) {
                        $("#btmPanel").hide();

                        this.toggleView( "#onboardView" );  
                   // } else {
                   //     this.toggleView( "#clikView" );  
                   // }
                };
                this.showVoteView = function() {
                    /* Show the "Vote" View */
                    // Update the title.
                    
                    if ( clik.connected ) {
                        $("#btmPanel").show();

                        $("#voteView_title").html("Bon Appetit, " + this.user.firstName);
                    
                        this.toggleView( "#voteView" );  
                        
                        // Checkin
                        clik.send( 'checkin', { name  : this.user.name,
                                                firstName : this.user.firstName,
                                                uuid  : this.user.uuid,
                                                img   : this.user.img } );
                    } else {
                        this.toggleView( "#clikView" );  
                    }
                };
                this.showProfileView = function() {
                    this.toggleView( "#profileView" );  
                };
                this.showEatingView = function() {
                    if( clik.connected ) {
                        this.toggleView( "#eatingView" );  
                    } else {
                        this.toggleView( "#clikView" );  
                    }
                };
                this.showClikView = function() {
                    if( clik.connected ) {
                        $("#clikView_in").hide();
                        $("#clikView_out").show();
                    } else {
                        $("#clikView_in").show();
                        $("#clikView_out").hide();
                    }

                    this.toggleView( "#clikView" );  
                };

                this.toggleView = function( selector ) {
                    this.currentView.hide();
                    $("#"+this.currentView.attr('id')+"Btn").attr('class', 'limeBtn panelBtn');

                    this.currentView = $( selector );

                    $("#"+this.currentView.attr('id')+"Btn").attr('class', 'lightBlueBtn panelBtn');
                    this.currentView.fadeIn();
                };

                // Ajax Functions ----------------------------------------------
                this.createUser = function( ) {
                    /* Create a new User obj on the Server. */

                    var firstName = $("#onboard_firstName").val();
                    var lastName  = $("#onboard_lastName").val();
                    var email     = $("#onboard_email").val();

                    // Cache this stuff!
                    this.user.firstName = firstName;
                    this.user.lastName  = lastName;
                    this.user.email     = email;

                     // Tell the Server to make a new User.
                     $.ajax({
                            url: "{% url CreateUser %}",
                            type: "POST",
                            data: ({ firstName : firstName,
                                     lastName  : lastName,
                                     email     : email } ),
                            success: function(response) {
                                // Store User info for future use.
                                MaitreMobile.user.uuid  = response.uuid;
                                MaitreMobile.user.img   = response.img;
                                
                                // Go to Vote View.
                                MaitreMobile.showVoteView();
                            },
                        });
                };

                this.vote = function( vote ) {
                    /* Assign a numerical value in range [1, 10] to the
                       current meal. 1 = bad, 10 = best. */

                    var vote_val = $( "#voteView_slider" ).slider( "value" );

                    // Tell Clik Desktop about the vote
                    clik.send( 'vote', { name       : this.user.name,
                                         firstName  : this.user.firstName,
                                         uuid       : this.user.uuid,
                                         img        : this.user.img,
                                         vote_value : vote_val } );
                    // Tell server
                    $.ajax({ url: "{% url DoVote %}",
                             type: "POST",
                             data: ({ value : vote_val } ),
                             success: function(response) {
                                 // Go to Thanks View on successful vote.
                                 MaitreMobile.showProfileView();
                             },
                          });
                };
            };

            MaitreMobile.run();
        </script>
    </body>
</html>
